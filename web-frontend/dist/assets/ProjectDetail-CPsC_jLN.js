import{n as S,_ as ie,p as ce,r,q as ue,o as de,c as v,a as d,e as o,s as pe,b as s,w as a,g as n,v as _e,d as B,t as i,F as me,h as ve,x as fe,y as he,z as ge,u as ye,k as _,f as F,l as j,E as H}from"./index-DfyFu52l.js";import{g as we}from"./inspection-oGYkHLV3.js";import{a as q}from"./date-Bl3ggAUA.js";import{f as ke,d as je}from"./format-DTuyiYXy.js";function Ce(){return S({url:"/templates",method:"get"})}function be(C,$){return S({url:`/projects/${C}/report`,method:"post",data:$})}function $e(C){return S({url:`/projects/${C}/report`,method:"get",responseType:"blob"})}const Ie={class:"project-detail"},xe={class:"card-header"},De={class:"project-code"},Ve={key:0,class:"project-description"},ze={key:1,class:"project-statistics"},Re={class:"hosts-section"},Te={key:0,class:"loading-container"},Pe={key:1,class:"hosts-grid"},Be={class:"host-icon"},Fe={class:"host-info"},He={class:"host-ip"},Se={class:"host-details"},Le={class:"host-meta"},Me={class:"meta-item"},Ne={class:"meta-item"},Ee={key:0,class:"template-info-display"},Ue={class:"template-desc-text"},qe={__name:"ProjectDetail",setup(C){const $=ye(),m=ce().params.projectCode,I=r(!1),x=r(!1),c=r(null),g=r(null),f=r([]),D=r({}),y=r(!1),b=r(!1),w=r([]),V=r(!1),L=r(null),u=r({title:`服务器巡检报告 - ${m}`,templateId:null}),A=async()=>{I.value=!0;try{const t=await fe(m);c.value=t.data,u.value.title=`服务器巡检报告 - ${t.data.project_name}`}catch(t){console.error("获取项目信息失败:",t)}finally{I.value=!1}},G=async()=>{var t;try{if((t=c.value)!=null&&t.id){const e=await he(c.value.id);g.value=e.data.statistics}}catch(e){console.error("获取统计信息失败:",e)}},J=async()=>{var t;x.value=!0;try{if((t=c.value)!=null&&t.id){const e=await ge(c.value.id);f.value=e.data.hosts||[];for(const p of f.value)await K(p.hostname)}}catch(e){console.error("获取主机列表失败:",e)}finally{x.value=!1}},K=async t=>{var e;try{const p=await we({hostname:t,project_id:m,page:1,page_size:1});D.value[t]=((e=p.data)==null?void 0:e.total)||0}catch(p){console.error("获取主机巡检次数失败:",p),D.value[t]=0}},O=t=>D.value[t]||0,Q=async()=>{try{const t=await Ce();w.value=t.data.templates||[];const e=w.value.find(p=>p.is_default);e?u.value.templateId=e.id:w.value.length>0&&(u.value.templateId=w.value[0].id)}catch(t){console.error("获取模板列表失败:",t)}},z=ue(()=>w.value.find(t=>t.id===u.value.templateId)),W=async()=>{if(!u.value.templateId){H.warning("请选择报告模板");return}V.value=!0;try{const t=await be(c.value.id,{options:{title:u.value.title,template_id:u.value.templateId}});L.value=t.data,y.value=!1,b.value=!0,H.success("报告生成成功")}catch(t){console.error("生成报告失败:",t)}finally{V.value=!1}},X=async()=>{try{const t=await $e(c.value.id),e=`${m}_${Date.now()}.docx`;je(t.data,e),b.value=!1,H.success("报告下载成功")}catch(t){console.error("下载报告失败:",t)}},Y=t=>{$.push(`/projects/${m}/hosts/${t.hostname}`)};return de(async()=>{await A(),await G(),await J(),await Q()}),(t,e)=>{const p=n("ArrowLeft"),h=n("el-icon"),k=n("el-button"),M=n("Document"),R=n("el-statistic"),N=n("el-card"),Z=n("el-skeleton"),ee=n("Monitor"),E=n("el-tag"),te=n("Clock"),oe=n("el-empty"),T=n("el-input"),P=n("el-form-item"),le=n("el-form"),U=n("el-dialog"),ae=n("Download"),se=n("el-result"),ne=_e("loading");return d(),v("div",Ie,[o(k,{onClick:e[0]||(e[0]=l=>t.$router.push("/")),class:"back-btn"},{default:a(()=>[o(h,null,{default:a(()=>[o(p)]),_:1}),e[6]||(e[6]=_(" 返回 ",-1))]),_:1}),pe((d(),B(N,{class:"project-info-card"},{header:a(()=>{var l;return[s("div",xe,[s("div",null,[s("h2",null,i(((l=c.value)==null?void 0:l.project_name)||j(m)),1),s("p",De,i(j(m)),1)]),o(k,{type:"primary",onClick:e[1]||(e[1]=re=>y.value=!0)},{default:a(()=>[o(h,null,{default:a(()=>[o(M)]),_:1}),e[7]||(e[7]=_(" 生成巡检报告 ",-1))]),_:1})])]}),default:a(()=>{var l;return[(l=c.value)!=null&&l.description?(d(),v("div",Ve,i(c.value.description),1)):F("",!0),g.value?(d(),v("div",ze,[o(R,{title:"主机数量",value:g.value.total_hosts,suffix:"台"},null,8,["value"]),o(R,{title:"巡检次数",value:g.value.total_inspections,suffix:"次"},null,8,["value"]),o(R,{title:"最新巡检",value:j(q)(g.value.latest_inspection)},null,8,["value"])])):F("",!0)]}),_:1})),[[ne,I.value]]),s("div",Re,[s("h3",null,"主机列表 (共 "+i(f.value.length)+" 台)",1),x.value?(d(),v("div",Te,[o(Z,{rows:2,animated:""})])):f.value.length>0?(d(),v("div",Pe,[(d(!0),v(me,null,ve(f.value,l=>(d(),B(N,{key:l.hostname,class:"host-card",shadow:"hover",onClick:re=>Y(l)},{default:a(()=>[s("div",Be,[o(h,{size:32,color:"#67c23a"},{default:a(()=>[o(ee)]),_:1})]),s("div",Fe,[s("h4",null,i(l.hostname),1),s("p",He,i(l.ip),1),s("div",Se,[o(E,{size:"small"},{default:a(()=>[_(i(l.os),1)]),_:2},1024),o(E,{size:"small",type:"info"},{default:a(()=>[_(i(l.arch),1)]),_:2},1024)]),s("div",Le,[s("div",Me,[o(h,null,{default:a(()=>[o(te)]),_:1}),s("span",null,i(j(q)(l.timestamp)),1)]),s("div",Ne,[o(h,null,{default:a(()=>[o(M)]),_:1}),s("span",null,i(O(l.hostname))+" 次巡检",1)])])])]),_:2},1032,["onClick"]))),128))])):(d(),B(oe,{key:2,description:"该项目暂无主机数据","image-size":150}))]),o(U,{modelValue:y.value,"onUpdate:modelValue":e[4]||(e[4]=l=>y.value=l),title:"生成项目巡检报告",width:"600px","close-on-click-modal":!1},{footer:a(()=>[o(k,{onClick:e[3]||(e[3]=l=>y.value=!1)},{default:a(()=>[...e[9]||(e[9]=[_("取消",-1)])]),_:1}),o(k,{type:"primary",onClick:W,loading:V.value},{default:a(()=>[...e[10]||(e[10]=[_(" 生成报告 ",-1)])]),_:1},8,["loading"])]),default:a(()=>[o(le,{model:u.value,"label-width":"100px"},{default:a(()=>[o(P,{label:"项目名称"},{default:a(()=>{var l;return[o(T,{value:(l=c.value)==null?void 0:l.project_name,disabled:""},null,8,["value"])]}),_:1}),o(P,{label:"主机数量"},{default:a(()=>[o(T,{value:`${f.value.length} 台`,disabled:""},null,8,["value"])]),_:1}),o(P,{label:"报告标题"},{default:a(()=>[o(T,{modelValue:u.value.title,"onUpdate:modelValue":e[2]||(e[2]=l=>u.value.title=l),placeholder:"请输入报告标题"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"]),z.value?(d(),v("div",Ee,[s("p",null,[e[8]||(e[8]=s("strong",null,"使用模板:",-1)),_(" "+i(z.value.name),1)]),s("p",Ue,i(z.value.description),1)])):F("",!0)]),_:1},8,["modelValue"]),o(U,{modelValue:b.value,"onUpdate:modelValue":e[5]||(e[5]=l=>b.value=l),title:"报告生成成功",width:"400px"},{default:a(()=>{var l;return[o(se,{icon:"success",title:"报告已生成","sub-title":`文件大小: ${j(ke)((l=L.value)==null?void 0:l.file_size)}`},{extra:a(()=>[o(k,{type:"primary",onClick:X},{default:a(()=>[o(h,null,{default:a(()=>[o(ae)]),_:1}),e[11]||(e[11]=_(" 立即下载 ",-1))]),_:1})]),_:1},8,["sub-title"])]}),_:1},8,["modelValue"])])}}},Qe=ie(qe,[["__scopeId","data-v-763eb31d"]]);export{Qe as default};
