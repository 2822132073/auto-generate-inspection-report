import{_ as de,p as ue,r as h,A as H,o as _e,c as p,a as i,e as l,d as u,f,b as t,w as a,g as n,t as c,u as pe,k as r,l as z,F as O,h as T,s as M,B as q}from"./index-DfyFu52l.js";import{g as me,a as ve}from"./inspection-oGYkHLV3.js";import{b as G}from"./date-Bl3ggAUA.js";const he={class:"host-inspections"},fe={class:"card-header"},ge={class:"host-ip"},ye={class:"host-details-grid"},ke={class:"detail-item"},be={class:"value"},Ce={class:"detail-item"},we={class:"value"},ze={class:"detail-item"},xe={class:"value"},Ie={class:"detail-item"},De={class:"value"},je={class:"detail-item"},Be={class:"value"},Se={class:"timeline-section"},Ue={key:0,class:"loading-container"},Ae=["onClick"],Le={class:"header-left"},$e={class:"record-title"},Ee={class:"header-right"},Ne={class:"timeline-detail"},Re={class:"detail-section"},Ve={key:0,class:"detail-section"},Pe={key:1,class:"detail-section"},Fe={class:"commands-list"},He={class:"command-header"},Oe={class:"command-text"},Te={key:0,class:"command-output"},Me={class:"output-content"},qe={key:1,class:"command-screenshot"},Ge={class:"image-error"},Je={__name:"HostInspections",setup(Ke){const J=pe(),$=ue(),x=$.params.projectCode,E=$.params.hostname,I=h(!1),m=h([]),y=h(0),D=h(1),k=h(10),v=h(null),_=h([]),g=H({}),b=H({}),j=async()=>{I.value=!0;try{const o=await me({hostname:E,project_id:x,page:D.value,page_size:k.value,sort_by:"timestamp",sort_order:"desc"});if(m.value=o.data.records||[],y.value=o.data.total||0,m.value.length>0&&!v.value&&(v.value=m.value[0]),m.value.length>0&&_.value.length===0){const e=m.value[0].id;_.value.push(e),await N(e)}}catch(o){console.error("获取巡检记录失败:",o)}finally{I.value=!1}},N=async o=>{if(!g[o])try{const e=await ve(o);g[o]=e.data}catch(e){console.error("获取巡检详情失败:",e)}},K=async o=>{const e=_.value.indexOf(o);e>-1?_.value.splice(e,1):(_.value.push(o),await N(o))},Q=o=>{b[o]=!b[o]},W=o=>o?Object.entries(o).map(([e,B])=>({key:e,value:B})):[],R=o=>`/api/v1/screenshots/${o}`,X=()=>{J.push(`/projects/${x}`)};return _e(()=>{j()}),(o,e)=>{const B=n("ArrowLeft"),C=n("el-icon"),S=n("el-button"),U=n("el-card"),Y=n("el-skeleton"),Z=n("CircleCheck"),ee=n("CircleClose"),A=n("el-tag"),w=n("el-descriptions-item"),te=n("el-descriptions"),V=n("el-table-column"),se=n("el-table"),P=n("el-collapse-transition"),ae=n("Picture"),le=n("el-image"),oe=n("el-timeline-item"),ne=n("el-timeline"),ce=n("el-empty"),ie=n("el-pagination");return i(),p("div",he,[l(S,{onClick:X,class:"back-btn"},{default:a(()=>[l(C,null,{default:a(()=>[l(B)]),_:1}),e[2]||(e[2]=r(" 返回 ",-1))]),_:1}),v.value?(i(),u(U,{key:0,class:"host-info-card"},{header:a(()=>[t("div",fe,[t("div",null,[t("h2",null,c(z(E)),1),t("p",ge,c(v.value.ip),1)])])]),default:a(()=>[t("div",ye,[t("div",ke,[e[3]||(e[3]=t("span",{class:"label"},"操作系统:",-1)),t("span",be,c(v.value.os),1)]),t("div",Ce,[e[4]||(e[4]=t("span",{class:"label"},"内核版本:",-1)),t("span",we,c(v.value.kernel),1)]),t("div",ze,[e[5]||(e[5]=t("span",{class:"label"},"系统架构:",-1)),t("span",xe,c(v.value.arch),1)]),t("div",Ie,[e[6]||(e[6]=t("span",{class:"label"},"项目归属:",-1)),t("span",De,c(z(x)),1)]),t("div",je,[e[7]||(e[7]=t("span",{class:"label"},"巡检总次数:",-1)),t("span",Be,c(y.value)+" 次",1)])])]),_:1})):f("",!0),t("div",Se,[t("h3",null,"巡检记录 (共 "+c(y.value)+" 次)",1),I.value?(i(),p("div",Ue,[l(Y,{rows:3,animated:""})])):m.value.length>0?(i(),u(ne,{key:1,class:"inspection-timeline"},{default:a(()=>[(i(!0),p(O,null,T(m.value,(s,Qe)=>(i(),u(oe,{key:s.id,timestamp:z(G)(s.timestamp),placement:"top",type:s.status==="completed"?"success":"danger"},{default:a(()=>[l(U,{class:"timeline-card"},{default:a(()=>[t("div",{class:"timeline-header",onClick:L=>K(s.id)},[t("div",Le,[s.status==="completed"?(i(),u(C,{key:0,color:"#67c23a"},{default:a(()=>[l(Z)]),_:1})):(i(),u(C,{key:1,color:"#f56c6c"},{default:a(()=>[l(ee)]),_:1})),t("span",$e,"巡检记录 #"+c(s.id),1)]),t("div",Ee,[l(A,{size:"small"},{default:a(()=>[r(c(s.commands_count)+" 个命令",1)]),_:2},1024),l(S,{icon:_.value.includes(s.id)?"ArrowUp":"ArrowDown",size:"small",text:""},{default:a(()=>[r(c(_.value.includes(s.id)?"收起":"展开"),1)]),_:2},1032,["icon"])])],8,Ae),l(P,null,{default:a(()=>{var L,F;return[M(t("div",Ne,[t("div",Re,[e[8]||(e[8]=t("h4",null,"基本信息",-1)),l(te,{column:2,border:"",size:"small"},{default:a(()=>[l(w,{label:"记录 ID"},{default:a(()=>[r(c(s.id),1)]),_:2},1024),l(w,{label:"巡检时间"},{default:a(()=>[r(c(z(G)(s.timestamp)),1)]),_:2},1024),l(w,{label:"状态"},{default:a(()=>[l(A,{type:s.status==="completed"?"success":"danger",size:"small"},{default:a(()=>[r(c(s.status),1)]),_:2},1032,["type"])]),_:2},1024),s.notes?(i(),u(w,{key:0,label:"备注"},{default:a(()=>[r(c(s.notes),1)]),_:2},1024)):f("",!0)]),_:2},1024)]),(L=g[s.id])!=null&&L.env?(i(),p("div",Ve,[t("h4",null,[e[9]||(e[9]=r(" 环境变量 ",-1)),l(S,{onClick:d=>Q(s.id),size:"small",text:""},{default:a(()=>[r(c(b[s.id]?"收起":"展开"),1)]),_:2},1032,["onClick"])]),l(P,null,{default:a(()=>[M(l(se,{data:W(g[s.id].env),size:"small",border:"","max-height":"300"},{default:a(()=>[l(V,{prop:"key",label:"变量名",width:"200"}),l(V,{prop:"value",label:"变量值"})]),_:1},8,["data"]),[[q,b[s.id]]])]),_:2},1024)])):f("",!0),(F=g[s.id])!=null&&F.commands?(i(),p("div",Pe,[e[13]||(e[13]=t("h4",null,"命令执行列表",-1)),t("div",Fe,[(i(!0),p(O,null,T(g[s.id].commands,(d,re)=>(i(),u(U,{key:re,class:"command-card",shadow:"never"},{default:a(()=>[t("div",He,[t("code",Oe,c(d.command),1),l(A,{type:d.return_code===0?"success":"danger",size:"small"},{default:a(()=>[r(" 返回码: "+c(d.return_code),1)]),_:2},1032,["type"])]),d.output?(i(),p("div",Te,[e[10]||(e[10]=t("div",{class:"output-label"},"执行结果:",-1)),t("pre",Me,c(d.output),1)])):f("",!0),d.screenshot_path?(i(),p("div",qe,[e[12]||(e[12]=t("div",{class:"output-label"},"终端截图:",-1)),l(le,{src:R(d.screenshot_path),fit:"contain","preview-src-list":[R(d.screenshot_path)],class:"screenshot-img"},{error:a(()=>[t("div",Ge,[l(C,null,{default:a(()=>[l(ae)]),_:1}),e[11]||(e[11]=t("span",null,"加载失败",-1))])]),_:1},8,["src","preview-src-list"])])):f("",!0)]),_:2},1024))),128))])])):f("",!0)],512),[[q,_.value.includes(s.id)]])]}),_:2},1024)]),_:2},1024)]),_:2},1032,["timestamp","type"]))),128))]),_:1})):(i(),u(ce,{key:2,description:"该主机暂无巡检记录","image-size":150})),y.value>k.value?(i(),u(ie,{key:3,"current-page":D.value,"onUpdate:currentPage":e[0]||(e[0]=s=>D.value=s),"page-size":k.value,"onUpdate:pageSize":e[1]||(e[1]=s=>k.value=s),total:y.value,"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next, jumper",onCurrentChange:j,onSizeChange:j,class:"pagination"},null,8,["current-page","page-size","total"])):f("",!0)])])}}},Ze=de(Je,[["__scopeId","data-v-dda4ce9b"]]);export{Ze as default};
